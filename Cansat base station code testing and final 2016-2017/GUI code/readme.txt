Re-wrote all of the code